<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CHAOS INSURGENCY - USER DASHBOARD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
    body {
      font-family: 'VT323', monospace;
      overflow: hidden;
      background: #000;
      color: #0f0;
    }
    .grid-bg {
      background-image:
        linear-gradient(rgba(0,255,0,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,255,0,0.05) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .crt-effect {
      position: fixed; inset: 0;
      background:
        linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%),
        linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
      background-size: 100% 2px, 3px 100%;
      pointer-events: none; z-index: 9999;
      animation: flicker .15s infinite;
    }
    @keyframes flicker { 0%{opacity:.9} 50%{opacity:1} 100%{opacity:.9} }

    .terminal-text { text-shadow: 0 0 5px #0f0; }
    .desktop-background { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:0; }
    .desktop-logo {
      width: 420px; max-width: 55vmin; opacity:.5;
      filter: drop-shadow(0 0 4px #fff) drop-shadow(0 0 8px rgba(0,255,0,.8))
              drop-shadow(0 0 16px rgba(0,255,0,.6)) drop-shadow(0 0 24px rgba(0,255,0,.4));
    }
    .icon { transition: all .3s ease-in-out; }
    .icon:hover { filter: drop-shadow(0 0 8px rgba(0,255,0,.8)); transform: scale(1.05); }

    .window {
      animation: windowOpen .25s ease-in-out forwards;
      opacity: 0; transform: scale(.95);
      user-select: none;
      min-width: 300px; min-height: 200px;
      resize: none; overflow: hidden;
    }
    @keyframes windowOpen { to { opacity:1; transform:scale(1); } }
    .window-close-anim { animation: windowClose .25s ease-in-out forwards; }
    @keyframes windowClose { to { opacity:0; transform:scale(.95); } }

    /* make content actually fill when resized/maximized */
    .window > .frame { display:flex; flex-direction:column; width:100%; height:100%; }
    .window .content { flex: 1 1 auto; min-height:0; overflow:auto; user-select:text; }

    /* resize handles */
    .resize-handle { position:absolute; z-index:100; background:transparent; }
    .resize-n { top:0; left:0; right:0; height:5px; cursor:n-resize; }
    .resize-s { bottom:0; left:0; right:0; height:5px; cursor:s-resize; }
    .resize-e { top:0; right:0; bottom:0; width:5px; cursor:e-resize; }
    .resize-w { top:0; left:0; bottom:0; width:5px; cursor:w-resize; }
    .resize-ne { top:0; right:0; width:10px; height:10px; cursor:ne-resize; }
    .resize-nw { top:0; left:0; width:10px; height:10px; cursor:nw-resize; }
    .resize-se { bottom:0; right:0; width:10px; height:10px; cursor:se-resize; }
    .resize-sw { bottom:0; left:0; width:10px; height:10px; cursor:sw-resize; }

    .cursor-blink { animation: blink 1s infinite ease-in-out; }
    @keyframes blink { 0%{opacity:.2} 50%{opacity:1} 100%{opacity:.2} }
  </style>
</head>
<body class="grid-bg h-screen overflow-hidden">
  <div class="crt-effect"></div>

  <!-- Loading Screen -->
  <div id="loading-screen" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
    <div class="text-center">
      <img src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Chaos_Insurgency_logo.png" class="mx-auto w-32 h-32 animate-pulse mb-4" alt="">
      <div class="text-green-500 text-xl mb-2">CHAOS INSURGENCY</div>
      <div class="text-green-500 mb-8">LOADING USER DASHBOARD...</div>
      <div class="w-64 h-1 bg-green-900 mx-auto overflow-hidden">
        <div id="loading-progress" class="h-full bg-green-500" style="width:0%"></div>
      </div>
      <div id="loading-status" class="text-green-500 text-sm mt-2">Initializing user session...</div>
    </div>
  </div>

  <!-- Desktop -->
  <div id="desktop" class="hidden h-full w-full p-4 relative" style="z-index:1;">
    <div class="desktop-background" id="desktop-bg">
      <img class="desktop-logo" src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Chaos_Insurgency_logo.png" alt="">
    </div>

    <!-- Taskbar -->
    <div class="fixed bottom-0 left-0 right-0 h-10 bg-black/90 border-t border-green-500 flex items-center px-2 z-30">
      <button class="h-8 w-8 bg-green-900 border border-green-500 flex items-center justify-center mr-2 hover:bg-green-800">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Chaos_Insurgency_logo.png" class="w-5 h-5" alt="">
      </button>
      <div id="taskbar-items" class="flex-1 flex items-center gap-1 px-2 overflow-x-auto"></div>
      <div class="ml-auto flex items-center bg-black/70 border border-green-500 px-3 py-1 text-green-500">
        <i data-feather="clock" class="mr-2 w-4 h-4"></i><span id="clock">00:00:00</span>
      </div>
    </div>

    <!-- Desktop Icons -->
    <div id="desktop-icons" class="absolute left-4 top-4 flex flex-col gap-6 w-32" style="bottom:50px;">
      <div class="icon group flex flex-col items-center cursor-pointer draggable-icon" data-icon-id="terminal" title="Open Terminal">
        <div class="w-12 h-12 bg-green-900 border border-green-500 flex items-center justify-center mb-1">
          <i data-feather="terminal" class="text-green-500"></i>
        </div>
        <span class="text-green-500 text-center text-sm">Chaos Insurgency<br>Database</span>
      </div>
      <div class="icon group flex flex-col items-center cursor-pointer draggable-icon" data-icon-id="bg-manager" title="Background Manager">
        <div class="w-12 h-12 bg-green-900 border border-green-500 flex items-center justify-center mb-1">
          <i data-feather="image" class="text-green-500"></i>
        </div>
        <span class="text-green-500 text-center text-sm">Background<br>Manager</span>
      </div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="click-sound" src="Audio/click.mp3" preload="auto"></audio>
  <audio id="window-open" src="Audio/window-open.mp3" preload="auto"></audio>
  <audio id="window-close" src="Audio/window-close.mp3" preload="auto"></audio>
  <audio id="hum-sound" src="Audio/ambience-hum.mp3" preload="auto" loop></audio>

  <script>
    /* -----------------------
       BOOT / LOADING
    ----------------------- */
    document.addEventListener('DOMContentLoaded', startLoadingSequence);

    function startLoadingSequence() {
      const loadingScreen = document.getElementById('loading-screen');
      const loadingProgress = document.getElementById('loading-progress');
      const loadingStatus = document.getElementById('loading-status');
      const desktopIcons = document.getElementById('desktop-icons');

      // prevent accidental selects on quick dblclick
      desktopIcons.addEventListener('dblclick', (e) => { e.preventDefault(); e.stopPropagation(); });

      const messages = [
        "Verifying user credentials...",
        "Loading personalized dashboard...",
        "Accessing user-specific modules...",
        "Establishing secure connection...",
        "Welcome to your custom dashboard"
      ];

      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
          progress = 100; clearInterval(interval);
          loadingStatus.textContent = "DASHBOARD LOADED SUCCESSFULLY";
          setTimeout(() => {
            loadingScreen.style.transition = 'opacity .5s';
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
              loadingScreen.remove();
              document.getElementById('desktop').classList.remove('hidden');
              document.getElementById('hum-sound').volume = 0.1;
              document.getElementById('hum-sound').play();
              setupDraggableIcons();
              loadIconPositions();
            }, 500);
          }, 1000);
        }
        loadingProgress.style.width = `${progress}%`;
        if (progress % 20 < 1) {
          const idx = Math.min(Math.floor(progress / 20), messages.length - 1);
          loadingStatus.textContent = messages[idx];
        }
      }, 250);

      updateClock(); setInterval(updateClock, 1000);
      feather.replace();
      loadBackground(); // ensure background loads early
    }

    function updateClock() {
      document.getElementById('clock').textContent = new Date().toLocaleTimeString();
    }

    /* -----------------------
       WINDOW TEMPLATES (kept OFF-DOM)
    ----------------------- */
    // Terminal template (not appended; cloned on open)
    const terminalTemplate = document.createElement('div');
    terminalTemplate.className = 'hidden fixed top-20 left-20 z-50 window shadow-lg';
    terminalTemplate.style.width = '600px';
    terminalTemplate.style.height = '400px';
    terminalTemplate.id = 'terminal-window-template';
    terminalTemplate.innerHTML = `
      <div class="frame bg-black border border-green-500">
        <div class="bg-green-900 border-b border-green-500 p-2 flex justify-between items-center drag-handle">
          <span class="text-green-500">Chaos Insurgency Database Terminal</span>
          <div class="flex gap-1">
            <button data-action="minimize" class="w-6 h-6 flex items-center justify-center hover:bg-green-800"><i data-feather="minus" class="text-green-500 w-4 h-4"></i></button>
            <button data-action="maximize" class="w-6 h-6 flex items-center justify-center hover:bg-green-800"><i data-feather="maximize-2" class="text-green-500 w-4 h-4"></i></button>
            <button data-action="close" class="w-6 h-6 flex items-center justify-center hover:bg-red-700"><i data-feather="x" class="text-green-500 w-4 h-4"></i></button>
          </div>
        </div>
        <div class="content p-4 terminal-text">
          <pre class="text-green-500 text-lg">
██████╗ ██╗  ██╗  █████╗   ██████╗  ███████╗
██╔══██╗██║  ██║██╔══██╗██╔════╝ ██╔════╝
██████╔╝███████║███████║██║  ███╗█████╗  
██╔═══╝ ██╔══██║██╔══██║██║   ██║██╔══╝  
██║     ██║   ██║██║  ██║╚██████╔╝███████╗
╚═╝     ╚═╝   ╚═╝╚═╝  ╚═╝ ╚═════╝ ╚══════╝
CHAOS INSURGENCY DATABASE TERMINAL v1.0
          </pre>
          <div class="mt-4">
            <p class="text-green-500">> Welcome to Chaos Insurgency Database Terminal</p>
            <p class="text-green-500">> Type HELP for available commands</p>
            <div class="mt-4 flex">
              <span class="text-green-500">></span>
              <input type="text" class="bg-black text-green-500 px-2 flex-grow focus:outline-none" placeholder="Enter command..." id="command-input">
              <span class="text-green-500 cursor-blink">_</span>
            </div>
            <div id="command-output" class="mt-4"></div>
          </div>
        </div>
      </div>
    `;

    // Background Manager template (not appended; cloned on open)
    const bgManagerTemplate = document.createElement('div');
    bgManagerTemplate.className = 'hidden fixed top-20 left-20 z-50 window shadow-lg';
    bgManagerTemplate.style.width = '600px';
    bgManagerTemplate.style.height = '400px';
    bgManagerTemplate.id = 'bg-manager-window-template';
    bgManagerTemplate.innerHTML = `
      <div class="frame bg-black border border-green-500">
        <div class="bg-green-900 border-b border-green-500 p-2 flex justify-between items-center drag-handle">
          <span class="text-green-500">Background Manager</span>
          <div class="flex gap-1">
            <button data-action="minimize" class="w-6 h-6 flex items-center justify-center hover:bg-green-800"><i data-feather="minus" class="text-green-500 w-4 h-4"></i></button>
            <button data-action="maximize" class="w-6 h-6 flex items-center justify-center hover:bg-green-800"><i data-feather="maximize-2" class="text-green-500 w-4 h-4"></i></button>
            <button data-action="close" class="w-6 h-6 flex items-center justify-center hover:bg-red-700"><i data-feather="x" class="text-green-500 w-4 h-4"></i></button>
          </div>
        </div>
        <div class="content p-4">
          <h2 class="text-green-500 text-xl mb-4">Background Manager</h2>
          <div class="mb-4">
            <label class="block text-green-500 mb-2">Image URL:</label>
            <input type="text" id="bg-url" class="w-full bg-black border border-green-500 text-green-500 px-2 py-1 mb-2">
            <button id="bg-set" class="bg-green-900 border border-green-500 text-green-500 px-4 py-1 hover:bg-green-800">Set Background</button>
          </div>
          <button id="bg-clear" class="bg-red-900 border border-red-500 text-red-500 px-4 py-1 hover:bg-red-800">Clear to Default</button>
        </div>
      </div>
    `;

    /* -----------------------
       WINDOW ENGINE
    ----------------------- */
    function initWindowBehavior(win, idForTaskbar) {
      const header = win.querySelector('.drag-handle');
      makeDraggable(win, header);
      addResizeHandles(win);

      win.querySelectorAll('[data-action]').forEach(btn => {
        const action = btn.dataset.action;
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (action === 'minimize') minimizeWindow(win, idForTaskbar);
          if (action === 'maximize') toggleMaximizeElement(win);
          if (action === 'close') closeWindowByElement(win, idForTaskbar);
        });
      });

      win.addEventListener('mousedown', () => bringToFront(win));
    }

    function bringToFront(win) {
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = '1');
      win.style.zIndex = '50';
    }

    function minimizeWindow(win, idForTaskbar) {
      win.classList.add('hidden');
      const item = document.querySelector(`#taskbar-item-${idForTaskbar}`);
      if (item) item.classList.remove('bg-green-700');
    }

    function toggleMaximizeElement(win) {
      const wasMax = win.classList.contains('maximized');
      if (wasMax) {
        win.classList.remove('maximized');
        win.style.width  = win.dataset.lastWidth  || '600px';
        win.style.height = win.dataset.lastHeight || '400px';
        win.style.top    = win.dataset.lastTop    || '20px';
        win.style.left   = win.dataset.lastLeft   || '20px';
      } else {
        win.dataset.lastLeft   = win.style.left;
        win.dataset.lastTop    = win.style.top;
        win.dataset.lastWidth  = win.style.width;
        win.dataset.lastHeight = win.style.height;
        win.classList.add('maximized');
        win.style.width  = 'calc(100vw - 8px)';
        win.style.height = 'calc(100vh - 50px)'; // leave room for taskbar
        win.style.top = '4px';
        win.style.left = '4px';
      }
    }

    function closeWindowByElement(win, idForTaskbar) {
      win.classList.add('window-close-anim');
      setTimeout(() => {
        win.remove();
        removeFromTaskbar(idForTaskbar);
        const s = document.getElementById('window-close'); if (s) s.play();
      }, 250);
    }

    // convenience for inline calls
    function closeWindow(windowId) {
      const win = document.getElementById(`${windowId}-window`);
      if (!win) return;
      closeWindowByElement(win, windowId);
    }

    function addResizeHandles(win) {
      if (win.dataset.resizers === '1') return;
      const dirs = ['nw','n','ne','e','se','s','sw','w'];
      dirs.forEach(dir => {
        const h = document.createElement('div');
        h.className = `resize-handle resize-${dir}`;
        win.appendChild(h);
        h.addEventListener('mousedown', e => startResize(e, win, dir));
      });
      win.dataset.resizers = '1';
    }

    function startResize(e, win, dir) {
      e.preventDefault(); e.stopPropagation();
      bringToFront(win);
      const startX = e.clientX, startY = e.clientY;
      const rect = win.getBoundingClientRect();
      const start = { w: rect.width, h: rect.height, l: rect.left, t: rect.top };

      function onMove(ev) {
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        let w = start.w, h = start.h, l = start.l, t = start.t;

        if (dir.includes('e')) w = Math.max(300, start.w + dx);
        if (dir.includes('s')) h = Math.max(200, start.h + dy);
        if (dir.includes('w')) { w = Math.max(300, start.w - dx); l = start.l + dx; }
        if (dir.includes('n')) { h = Math.max(200, start.h - dy); t = start.t + dy; }

        l = Math.max(0, Math.min(l, window.innerWidth - w));
        t = Math.max(0, Math.min(t, window.innerHeight - h));

        Object.assign(win.style, {
          width: w + 'px', height: h + 'px',
          left: l + 'px', top: t + 'px',
          position: 'fixed'
        });
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    }

    function makeDraggable(win, handle) {
      let isDragging = false, offX = 0, offY = 0;
      handle.style.cursor = 'move';

      handle.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        isDragging = true;
        bringToFront(win);
        const rect = win.getBoundingClientRect();
        offX = e.clientX - rect.left;
        offY = e.clientY - rect.top;
        win.style.position = 'fixed';
        win.style.transition = 'none';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        let l = e.clientX - offX;
        let t = e.clientY - offY;
        l = Math.max(0, Math.min(l, window.innerWidth - win.offsetWidth));
        t = Math.max(0, Math.min(t, window.innerHeight - win.offsetHeight));
        win.style.left = l + 'px';
        win.style.top  = t + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        document.body.style.userSelect = 'auto';
        win.style.transition = 'all .2s ease';
      });
    }

    /* -----------------------
       ICONS (drag + dblclick)
    ----------------------- */
    function setupDraggableIcons() {
      const icons = document.querySelectorAll('.draggable-icon');
      icons.forEach(icon => {
        makeDraggable(icon, icon);
        icon.addEventListener('dblclick', () => {
          const id = icon.dataset.iconId;
          if (id === 'terminal') launchTerminal();
          if (id === 'bg-manager') launchBgManager();
        });
      });
      setupAutoSaveIcons();
    }

    function saveIconPositions() {
      const icons = document.querySelectorAll('.draggable-icon');
      const pos = {};
      icons.forEach(icon => {
        pos[icon.dataset.iconId] = { left: icon.style.left, top: icon.style.top, position: 'absolute' };
      });
      localStorage.setItem('iconPositions', JSON.stringify(pos));
    }
    function loadIconPositions() {
      const saved = localStorage.getItem('iconPositions');
      if (!saved) return;
      const pos = JSON.parse(saved);
      Object.keys(pos).forEach(id => {
        const el = document.querySelector(`[data-icon-id="${id}"]`);
        if (el) {
          el.style.position = 'absolute';
          if (pos[id].left) el.style.left = pos[id].left;
          if (pos[id].top)  el.style.top  = pos[id].top;
        }
      });
    }
    function setupAutoSaveIcons() {
      document.querySelectorAll('.draggable-icon').forEach(icon => {
        icon.addEventListener('mouseup', (e) => {
          if (!e.detail || e.detail < 2) saveIconPositions();
        });
      });
    }

    /* -----------------------
       BACKGROUND
    ----------------------- */
    function setCustomBackground(win) {
      const urlInput = win.querySelector('#bg-url');
      const url = (urlInput?.value || '').trim();
      if (!url) return;

      if (!/^https?:\/\/.+\..+/.test(url)) {
        alert('Please enter a valid image URL (must start with http:// or https://)');
        return;
      }

      const testImg = new Image();
      testImg.onload = function () {
        localStorage.setItem('customBackground', url);
        const bg = document.getElementById('desktop-bg');
        bg.innerHTML = '';
        const img = document.createElement('img');
        img.src = url;
        img.className = 'w-full h-full object-cover';
        img.onerror = clearBackground;
        bg.appendChild(img);
      };
      testImg.onerror = function () {
        alert('Failed to load image. Please check the URL and try again.');
      };
      testImg.src = url;
    }

    function clearBackground() {
      localStorage.removeItem('customBackground');
      const bg = document.getElementById('desktop-bg');
      bg.innerHTML = '';
      const img = document.createElement('img');
      img.src = 'https://upload.wikimedia.org/wikipedia/commons/b/bf/Chaos_Insurgency_logo.png';
      img.className = 'desktop-logo';
      bg.appendChild(img);
    }

    function loadBackground() {
      const saved = localStorage.getItem('customBackground');
      if (saved) {
        const bg = document.getElementById('desktop-bg');
        bg.innerHTML = '';
        const img = document.createElement('img');
        img.src = saved;
        img.className = 'w-full h-full object-cover';
        img.onerror = clearBackground;
        bg.appendChild(img);
      }
    }

    /* -----------------------
       TASKBAR
    ----------------------- */
    function addToTaskbar(id, name, win) {
      const bar = document.getElementById('taskbar-items');
      let item = document.querySelector(`#taskbar-item-${id}`);
      if (!item) {
        item = document.createElement('div');
        item.id = `taskbar-item-${id}`;
        item.className = 'flex items-center h-8 px-2 bg-green-900 border border-green-500 text-green-500 cursor-pointer hover:bg-green-800';
        let icon = '';
        if (id === 'terminal') icon = '<i data-feather="terminal" class="w-4 h-4 mr-2"></i>';
        if (id === 'bg-manager') icon = '<i data-feather="image" class="w-4 h-4 mr-2"></i>';
        item.innerHTML = `${icon}<span>${name}</span>`;
        bar.appendChild(item);
        feather.replace();

        item.addEventListener('click', () => {
          const hidden = win.classList.contains('hidden');
          if (hidden) {
            win.classList.remove('hidden');
            bringToFront(win);
            item.classList.add('bg-green-700');
            const s = document.getElementById('window-open'); if (s) s.play();
          } else {
            minimizeWindow(win, id);
          }
        });

        win.addEventListener('mousedown', () => {
          document.querySelectorAll('#taskbar-items > div').forEach(el => el.classList.remove('bg-green-700'));
          item.classList.add('bg-green-700');
        });
      } else {
        item.classList.add('bg-green-700');
      }
    }
    function removeFromTaskbar(id) {
      const item = document.querySelector(`#taskbar-item-${id}`);
      if (item) item.remove();
    }

    /* -----------------------
       TERMINAL & FILES
    ----------------------- */
    const personnelFiles = {
      'mufflindoe.txt': 'https://raw.githubusercontent.com/CybRepr/ChaosPC.github.io/main/mufflindoe.txt'
    };
    const commands = {
      'HELP': 'Available commands: RECRUIT_LIST, SABOTAGE_PROTOCOL, FOUNDATION_SURVEILLANCE, PERSONNEL_FILES, DOWNLOAD [filename], CLEAR',
      'RECRUIT_LIST': 'Agent List:\n- Agent "Sigma"\n- Agent "Rook"\n- Agent "Viper"\n- Agent "Spectre"\n- Agent "Mirage"',
      'SABOTAGE_PROTOCOL': 'Operations: Site-19 infiltration, Area-12 surveillance, Site-64 neutralized. Next: Site-76',
      'FOUNDATION_SURVEILLANCE': 'SCP-173: Contained\nSCP-682: Breach attempt\nSCP-106: Active\nSCP-049: Research ongoing',
      'PERSONNEL_FILES': () => `Available Personnel Files:\n- ${Object.keys(personnelFiles).join('\n- ')}`,
      'CLEAR': ''
    };

    function wireTerminalIO(win) {
      const input = win.querySelector('#command-input');
      const output = win.querySelector('#command-output');
      if (!input || !output) return;

      input.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        const raw = input.value;
        const cmd = raw.toUpperCase();
        if (cmd.startsWith('DOWNLOAD ')) {
          const filename = raw.substring(9).trim().toLowerCase();
          output.innerHTML += `<p class="text-green-500">> ${raw}</p>`;
          if (personnelFiles[filename]) {
            downloadFile(filename, personnelFiles[filename]);
          } else {
            output.innerHTML += `<p class="text-red-500">ERROR: File not found. Use PERSONNEL_FILES to see available files.</p>`;
          }
        } else if (commands[cmd] !== undefined) {
          output.innerHTML += `<p class="text-green-500">> ${raw}</p>`;
          const val = typeof commands[cmd] === 'function' ? commands[cmd]() : commands[cmd];
          if (cmd === 'CLEAR') output.innerHTML = '';
          else output.innerHTML += `<p class="text-green-500" style="white-space:pre-wrap">${val}</p>`;
        } else {
          output.innerHTML += `<p class="text-green-500">> ${raw}</p><p class="text-red-500">ERROR: Unknown command.</p>`;
        }
        input.value = '';
        output.scrollTop = output.scrollHeight;
      });
    }

    function downloadFile(filename, url) {
      const desktop = document.getElementById('desktop');
      const fileIcon = document.createElement('div');
      fileIcon.className = 'icon group flex flex-col items-center cursor-pointer absolute';
      fileIcon.style.left = Math.random() * (window.innerWidth - 100) + 'px';
      fileIcon.style.top  = Math.random() * (window.innerHeight - 150) + 'px';
      fileIcon.innerHTML = `
        <div class="w-12 h-12 bg-blue-900 border border-blue-500 flex items-center justify-center mb-1">
          <i data-feather="file-text" class="text-blue-500"></i>
        </div>
        <span class="text-blue-500 text-center text-sm">${filename}</span>`;
      fileIcon.onclick = () => fetchFileContent(url);
      desktop.appendChild(fileIcon);
      feather.replace();
      const termOut = document.getElementById('command-output');
      if (termOut) termOut.innerHTML += `<p class="text-green-500">Download complete. File icon added to desktop.</p>`;
    }

    function fetchFileContent(url) {
      fetch(url).then(r => r.text()).then(displayFileContent).catch(() => alert('Failed to load file'));
    }

    function displayFileContent(content) {
      const html = content
        .replace(/\[b\](.*?)\[\/b\]/gi, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
      const win = document.createElement('div');
      win.id = 'personnel-file-window';
      win.className = 'fixed top-24 left-24 z-50 window shadow-lg';
      win.style.width = '600px'; win.style.height = '400px';
      win.innerHTML = `
        <div class="frame bg-black border border-green-500">
          <div class="bg-green-900 border-b border-green-500 p-2 flex justify-between items-center drag-handle">
            <span class="text-green-500">Personnel File</span>
            <div class="flex gap-1">
              <button data-action="minimize" class="w-6 h-6 flex items-center justify-center hover:bg-green-800"><i data-feather="minus" class="text-green-500 w-4 h-4"></i></button>
              <button data-action="maximize" class="w-6 h-6 flex items-center justify-center hover:bg-green-800"><i data-feather="maximize-2" class="text-green-500 w-4 h-4"></i></button>
              <button data-action="close" class="w-6 h-6 flex items-center justify-center hover:bg-red-700"><i data-feather="x" class="text-green-500 w-4 h-4"></i></button>
            </div>
          </div>
          <div class="content p-4 terminal-text">${html}</div>
        </div>`;
      document.body.appendChild(win);
      feather.replace();
      initWindowBehavior(win, 'personnel-file');
      bringToFront(win);
    }

    /* -----------------------
       LAUNCHERS
    ----------------------- */
    function launchTerminal() {
      let win = document.getElementById('terminal-window');
      if (!win) {
        win = terminalTemplate.cloneNode(true);
        win.id = 'terminal-window';
        win.classList.remove('hidden');
        document.body.appendChild(win);
        feather.replace();
        initWindowBehavior(win, 'terminal');
        wireTerminalIO(win);
      } else {
        win.classList.remove('hidden');
      }
      bringToFront(win);
      addToTaskbar('terminal', 'Terminal', win);
      const s = document.getElementById('window-open'); if (s) s.play();
      setTimeout(() => win.querySelector('#command-input')?.focus(), 50);
    }

    function launchBgManager() {
      let win = document.getElementById('bg-manager-window');
      if (!win) {
        win = bgManagerTemplate.cloneNode(true);
        win.id = 'bg-manager-window';
        win.classList.remove('hidden');
        document.body.appendChild(win);
        feather.replace();
        initWindowBehavior(win, 'bg-manager');

        // wire background controls (SCOPED TO THIS WINDOW)
        const bgSet   = win.querySelector('#bg-set');
        const bgClear = win.querySelector('#bg-clear');
        const bgUrl   = win.querySelector('#bg-url');

        if (bgSet)   bgSet.addEventListener('click', () => setCustomBackground(win));
        if (bgClear) bgClear.addEventListener('click', clearBackground);
        if (bgUrl) {
          bgUrl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') setCustomBackground(win);
          });
          const saved = localStorage.getItem('customBackground');
          if (saved) bgUrl.value = saved;
        }
      } else {
        win.classList.remove('hidden');
      }
      bringToFront(win);
      addToTaskbar('bg-manager', 'BG Manager', win);
      const s = document.getElementById('window-open'); if (s) s.play();
    }
  </script>
</body>
</html>
